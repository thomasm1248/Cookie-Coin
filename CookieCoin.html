<!DOCTYPE html>
<html>
<head>
	<meta name="description" content="Cookie Coin Wallet">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Cookie Coin</title>
	<style>

* {
	outline: none;
}

#container {
	width: 450px;
	margin: 100px auto 0;
}

#action-menu {
	width: 438px;
	border: 1px solid grey;
	border-radius: 5px;
	margin-bottom: 6px;
	padding: 5px;
	text-align: center;
}

#input {
	width: 200px;
	height: 200px;
	resize: none;
	padding: 10px;
	border-radius: 5px;
	border: 1px solid grey;
}
#output {
	width: 200px;
	min-height: 200px;
	word-wrap: break-word;
	border-radius: 5px;
	border: 1px solid grey;
	padding: 10px;
	float: right;
}

	</style>
</head>
<body>
	<script type="text/javascript">

var walletName = "";

function l(id) {return document.getElementById(id);}

function put(packet, name) {
	window.localStorage[name] = packet;
}

function get(name) {
	return window.localStorage[name];
}

function hash(string) {
  var hash = 0, i, chr, len;
  if (string.length === 0) return hash;
  for (i = 0, len = string.length; i < len; i++) {
    chr   = string.charCodeAt(i);
    hash  = ((hash << 5) - hash) + chr;
    hash |= 0; // Convert to 32bit integer
  }
  return hash;
}

function toPacket(data, type) {
	var hashCode = hash(JSON.stringify(data));
	var packet = [type, data, hashCode];
	return btoa(JSON.stringify(packet));
}

function fromPacket(string) {
	var packet = JSON.parse(atob(string));
	var hashCode = hash(JSON.stringify(packet[1]));
	if(packet[2] === hashCode) {
		return {
			valid: true,
			type: packet[0],
			data: packet[1]
		};
	} else {
		return {
			valid: false
		};
	}
}

function Wallet() {
	this.id = Math.random();
	this.ver = 1;
	this.coins = 0;
	this.activeTickets = [];
}

function getWallet() {
	// Get wallet packet from cookie
	var encodedPacket = get(walletName);
	if(encodedPacket !== undefined) {
		var packet = fromPacket(encodedPacket);
	} else {
		return false;
	}
	
	// Extract wallet
	if(!packet.valid) return;
	var wallet = packet.data;
	
	// Cleanup wallet
	var today = new Date();
	for(var i = 0; i < wallet.activeTickets; i++) {
		if((new Date(wallet.activeTickets[i][1] + "Z")) < today) {
			wallet.activeTickets.splice(i, 1);
			i--;
		}
	}
	
	// Return packet contents
	return wallet;
}

function saveWallet(wallet) {
	put(toPacket(wallet, "wallet"), walletName);
}










// Open a wallet
function actionOpenWallet() {
	// Get name of wallet
	walletName = prompt("Name:");
	
	// Get wallet
	var wallet = getWallet();
	
	// Print Info
	if(wallet) {
		l("output").innerHTML = "Coins: " + wallet.coins;
	} else {
		l("output").innerHTML = "Sorry, this wallet doesn't exist.";
	}
}




// Make a new wallet
function actionNewWallet() {
	// Make a new wallet
	var wallet = new Wallet();
	
	// Get name of new wallet
	walletName = prompt("Name:");
	
	// Print info
	l("output").innerHTML = "Coins: " + wallet.coins;
	
	// Store new wallet
	saveWallet(wallet);
}




// Generate a ticket
function actionNewTicket() {
	// Get wallet
	var wallet = getWallet();
	if(!wallet) return;
	
	// Generate a ticket
	var num = Math.random();
	var from = wallet.id;
	var due = new Date();
	due.setDate(due.getDate() + 1);
	
	// Add ticket to wallet
	wallet.activeTickets.push([
		num,
		due.toUTCString()
	]);
	
	// Give ticket to player
	l("output").innerHTML = "Coins: " + wallet.coins + "<br><br>Email this to the person you want coins from (expires in 24 hours):<br><br>" + toPacket([num, from], "Tv1");
	
	// Save wallet
	saveWallet(wallet);
}




// Generate a check
function newCheck(ticket) {
	// Get wallet
	var wallet = getWallet();
	
	// Ask for amount
	var amount;
	var notValid;
	var promptMessage = "You have: " + wallet.coins + ". How much do you want to send?";
	do {
		notValid = false;
		amount = prompt(promptMessage);
		if(!amount) {
			l("output").innerHTML = "Coins: " + wallet.coins + "<br><br>Transaction canceled.";
			return;
		}
		var num = new Number(amount);
		if(num === NaN) notValid = true;
		if(num < 0) notValid = true;
		if(num % 1 !== 0) notValid = true;
		if(num > wallet.coins) notValid = true;
		promptMessage = "Not valid. You have: " + wallet.coins + ". How much do you want to send?";
	} while(notValid);
	
	// Subtract amount from wallet
	wallet.coins -= amount;
	
	// Give check to player
	ticket.push(amount);
	l("output").innerHTML = "Coins: " + wallet.coins + "<br><br>Email this to the person who gave you the ticket:<br><br>" + toPacket(ticket, "Cv1");
	
	// Save wallet
	saveWallet(wallet);
}




// Cash a check
function cashCheck(check) {
	// Get wallet
	var wallet = getWallet();
	
	// Validate
	if(wallet.id !== check[1]) return;
	var verified = false;
	for(var i = 0; i < wallet.activeTickets.length; i++) {
		if(wallet.activeTickets[i][0] === check[0]) {
			verified = true;
			wallet.activeTickets.splice(i, 1);
			break;
		}
	}
	if(!verified) {
		l("output").innerHTML = "Coins: " + wallet.coins + "<br><br>The check either isn't for you, or it's ticket has expired (24 hours after printing ticket).";
		return;
	}
	
	// Add amount to wallet
	wallet.coins += check[2] *1;
	
	// Print info
	l("output").innerHTML = "Coins: " + wallet.coins + "<br><br>A check for " + check[2] + " coins has been added to your wallet.";
	
	// Save wallet
	saveWallet(wallet);
}




// Scan input
function actionScanInput() {
	// Read input into a variable
	var input = l("input").value;
	l("input").value = "";
	
	// Test input
	var valid = true;
	try {
		input = fromPacket(input);
	} catch(e) {
		valid = false;
	}
	
	if(valid) {
		if(!input.valid) {
			valid = false;
		}
	}
	
	if(valid) {
		switch(input.type) {
			case "Tv1":
				newCheck(input.data);
				break;
			case "Cv1":
				cashCheck(input.data);
				break;
		}
	}
	
	// Print Error if not valid
	if(!valid) {
		l("output").innerHTML = "Input was not a valid packet.";
	}
}

	</script>
	<div id="container">
		<div id="action-menu">
			<input type="button" value="Open" onclick="actionOpenWallet()">
			<input type="button" value="New" onclick="actionNewWallet()">
			<input type="button" value="Print Ticket" onclick="actionNewTicket()">
			<input type="button" value="Scan Input" onclick="actionScanInput()">
		</div>
		<textarea id="input" placeholder="Packet Input"></textarea>
		<div id="output">Welcome to Cookie Coin! <br><br> To start, open a wallet stored on this device or create a new, empty wallet. <br><br> What's this? This is a relatively cheat proof virtual currency that you can use among your friends. <br><br> How to use this:<br>To get coins from someone, print and send them a ticket. They will paste it into the "Packet Input", then click "Scan Input". They then send you a check that you paste into the "Packet Input" and click "Scan Input". That's it!</div>
	</div>
</body>
</html>
